{% extends "base.html" %}
{% block Style %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/billing.css') }}">
{% endblock %}
{% block title %}Billing{% endblock %}
{% block contentSection %}
    <div class="billing-container">
        <form method="POST" action="{{ url_for('submit_billing') }}" id="billing-form">
            <div class="saree-details">
                <h3>Add Saree Details</h3>
                <div class="form-group">
                    <label for="sareeId">Saree ID</label>
                    <input type="text" id="sareeId" name="sareeId" required placeholder="Enter Saree ID" onblur="fetchSareePrice()">
                </div>
                <div class="form-group">
                    <label for="cost">Cost (Rs.)</label>
                    <input type="number" id="cost" name="cost" required placeholder="Enter Cost">
                </div>
                <button type="button" class="Styled-button" id="add-saree">Add Saree</button>
            </div>
            
            <div class="saree-list">
                <h3>Added Sarees</h3>
                <div id="saree-list-container">
                    <!-- Dynamically added saree cards will appear here -->
                </div>
            </div>

            <div class="address-details">
                <h3>Address</h3>
                <div class="form-group">
                    <label for="address">Address</label>
                    <input type="text" id="address" name="address" required placeholder="Enter your address">
                </div>
            </div>

            <div class="payment-summary">
                <h3>Payment Summary</h3>
                <div id="payment-summary-container">
                    <p>Total Amount: <span id="total-amount">Rs. 0 /-</span></p>
                </div>
            </div>

            <button type="submit" class="Styled-button">Submit Billing</button>
        </form>
    </div>

    <script>
        const sareeListContainer = document.getElementById('saree-list-container');
        const totalAmountElement = document.getElementById('total-amount');
        let totalAmount = 0;

        // Function to fetch saree price from the database based on sareeId
        function fetchSareePrice() {
            const sareeId = document.getElementById('sareeId').value;

            if (sareeId) {
                fetch(`/getSareePrice?sareeId=${sareeId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.price) {
                            document.getElementById('cost').value = data.price; // Auto-fill price
                        } else {
                            alert("Saree not found in database.");
                            document.getElementById('cost').value = ''; // Clear the cost field
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching saree price:', error);
                        alert("Error fetching saree price.");
                    });
            }
        }

        document.getElementById('add-saree').addEventListener('click', function() {
            const sareeId = document.getElementById('sareeId').value;
            const cost = parseFloat(document.getElementById('cost').value);

            if (sareeId && cost) {
                // Create saree card
                const sareeCard = document.createElement('div');
                sareeCard.classList.add('saree-card');
                sareeCard.innerHTML = `
                    <p><strong>Saree ID:</strong> ${sareeId}</p>
                    <p><strong>Cost:</strong> Rs. ${cost} /-</p>
                    <button class="edit-button">Edit</button>
                    <button class="remove-button">Remove</button>
                `;
                sareeListContainer.appendChild(sareeCard);

                // Update total amount
                totalAmount += cost;
                totalAmountElement.textContent = `Rs. ${totalAmount} /-`;

                // Clear the input fields after adding
                document.getElementById('sareeId').value = '';
                document.getElementById('cost').value = '';

                // Add event listeners for edit and remove buttons
                sareeCard.querySelector('.edit-button').addEventListener('click', function() {
                    document.getElementById('sareeId').value = sareeId;
                    document.getElementById('cost').value = cost;
                    sareeCard.remove();  // Remove the saree card for editing
                    totalAmount -= cost;  // Update total amount
                    totalAmountElement.textContent = `Rs. ${totalAmount} /-`;
                });

                sareeCard.querySelector('.remove-button').addEventListener('click', function() {
                    sareeCard.remove();  // Remove the saree card
                    totalAmount -= cost;  // Update total amount
                    totalAmountElement.textContent = `Rs. ${totalAmount} /-`;
                });
            } else {
                alert("Please fill in both fields.");
            }
        });
    </script>
{% endblock %}
